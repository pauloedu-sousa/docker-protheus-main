(self.webpackChunkdbmonitor=self.webpackChunkdbmonitor||[]).push([[771],{3771:(j,k,l)=>{"use strict";l.r(k),l.d(k,{UsersComponent:()=>w});var v=l(467),g=l(177),e=l(4438),c=l(8622),S=l(1418),b=l(1850);l(5595);let _=(()=>{class p{constructor(t){this.poNotification=t}handleError(t){this.poNotification.error(`Error: ${t.status} - ${t.message}`),console.error(t)}handleMessage(t,o){switch(o){case"success":this.poNotification.success(t);break;case"warning":this.poNotification.warning(t)}}static#e=this.\u0275fac=function(o){return new(o||p)(e.KVO(c.cUO))};static#t=this.\u0275prov=e.jDH({token:p,factory:p.\u0275fac,providedIn:"root"})}return p})();var T=l(2578),n=l(1413),r=l(6977);const d=["traceModal"],i=["closeInformationsModal"],u=()=>({label:"PO Popup"}),E=p=>[p];let y,A=(()=>{class p{constructor(t,o,s){this.userService=t,this.poDialog=o,this.messagesHandle=s,this.userClosed=new e.bkB,this.isUserAdmin=!1,this.isUserKiller=!1,this.refreshTax=2,this.unsubscribe$=new n.B,this.startStopButtonTracer="Pausar",this.isHideLoading=!1,this.tracerItems=[],this.tracerColumns=[{property:"seq",label:"Seq"},{property:"time",label:"Tempo"},{property:"routine",label:"Rotina"},{property:"query",label:"Query"}],this.tableSpaceColumn=c.FZk.Small,this.closeInformations=""}ngDoCheck(){this.connectData||this.getDataOfSession()}ngOnInit(){this.getDataOfSession()}getDataOfSession(){const t=sessionStorage.getItem("configurationUserData");t&&(this.connectData=JSON.parse(t)),this.connectData&&(this.isUserAdmin=this.connectData.admin,this.isUserKiller=this.connectData.canKill)}buttonsAction(t){if(this.lineSelected)switch(this.stopAutoTracer(),t){case"Rastrear":this.openTrace();break;case"Encerrar":this.finishUser()}else this.messagesHandle.handleMessage(`Antes de ${t} deve ser selecionado um usu\xe1rio !`,"warning")}finishUser(){this.poDialog.confirm({title:"Encerrar Conex\xe3o",message:`<p style="font-size: medium;font-weight: bold;color: red;"> Deseja realmente encerrar a conex\xe3o id:<b> ${this.lineSelected.id}</b> do usu\xe1rio <b> ${this.lineSelected.user}</b> ? </p>`,confirm:()=>{this.finishUserConnection()}})}finishUserConnection(){this.userService.setUserTraceId(this.lineSelected.id)&&this.userService.killUser().pipe((0,r.Q)(this.unsubscribe$)).subscribe({next:()=>{this.userClosed.emit(!0)},error:t=>this.messagesHandle.handleError(t)})}openTrace(){console.log("footer"+this.lineSelected.id),this.userService.setUserTraceId(this.lineSelected.id)&&this.userService.startTrace().pipe((0,r.Q)(this.unsubscribe$)).subscribe({next:t=>{t&&(this.getTracerData().then(()=>{this.isHideLoading=!0,this.traceModal.open()}),this.startAutoTracer())},error:t=>this.messagesHandle.handleError(t)})}setStopInformations(){this.traceModal.close(),this.stopAutoTracer(),this.stopTracer(),this.closeInformationsModal.open()}closeInfoModal(){this.closeInformationsModal.close(),this.traceModal.close()}closeTracerButtom(){this.stopAutoTracer(),this.stopTracer()}getTracerData(){var t=this;return(0,v.A)(function*(){t.userService.getUserTracer().pipe((0,r.Q)(t.unsubscribe$)).subscribe({next:o=>{o.length>0&&(t.tracerItems=t.tracerItems.concat(o))},error:o=>t.messagesHandle.handleError(o)})})()}startAutoTracer(){y=setInterval(()=>{this.getTracerData()},1e3*this.refreshTax)}onClickSelectLineTracer(t){console.log("select line",t)}onClickUnselectLineTracer(){this.lineSelected=null}cleanTracer(){this.tracerItems=[]}stopAutoTracer(){clearInterval(y)}changeLabelStartStop(){"Pausar"===this.startStopButtonTracer?(this.stopAutoTracer(),this.startStopButtonTracer="Retomar"):(this.startAutoTracer(),this.startStopButtonTracer="Pausar")}copyTracerLine(){console.log("copy")}saveTracerToFile(){const t=new Blob([JSON.stringify(this.tracerItems)],{type:"text/plain;charset=utf-8"});(0,T.saveAs)(t,`dbTrace.${this.lineSelected.id}.${this.lineSelected.user}.trc`)}stopTracer(){this.userService.stopTrace().pipe((0,r.Q)(this.unsubscribe$)).subscribe({next:()=>{},error:t=>this.messagesHandle.handleError(t)})}ngOnDestroy(){this.stopAutoTracer(),this.stopTracer(),this.unsubscribe$.next(!1),this.unsubscribe$.complete()}static#e=this.\u0275fac=function(o){return new(o||p)(e.rXU(b.g),e.rXU(c.Vxt),e.rXU(_))};static#t=this.\u0275cmp=e.VBU({type:p,selectors:[["user-footer"]],viewQuery:function(o,s){if(1&o&&(e.GBs(d,7),e.GBs(i,7)),2&o){let a;e.mGM(a=e.lsd())&&(s.traceModal=a.first),e.mGM(a=e.lsd())&&(s.closeInformationsModal=a.first)}},inputs:{lineSelected:"lineSelected"},outputs:{userClosed:"userClosed"},standalone:!0,features:[e.Jv_([]),e.aNF],decls:24,vars:25,consts:[["popupClose",""],["traceModal",""],["closeInformationsModal",""],[1,"po-row","po-p-1"],["p-label","Encerrar","icon","po-icon-exit",3,"p-click","p-disabled"],["p-label","Rastrear","p-icon","po-icon-signal",3,"p-click"],["p-position","top-right",3,"p-actions","p-target"],["p-popup-header-template",""],[1,"popup-header-template"],["p-size","lg","p-title","Rastreando",3,"p-hide-close","p-click-out"],["p-text","Carregando Logs",3,"hidden"],["p-container","border","p-hide-batch-actions","true",1,"po-md-12",3,"p-selected","p-unselected","p-columns","p-items","p-height","p-hide-columns-manager","p-infinite-scroll","p-selectable","p-selectable-entire-line","p-single-select","p-striped","p-max-columns"],["p-label","Limpar",3,"p-click"],[3,"p-click","p-label"],["p-label","Copiar",3,"p-click","p-disabled"],["p-label","Salvar",3,"p-click","p-disabled"],["p-label","Fechar",3,"p-click"],["p-size","auto","p-title","Trace Info",3,"p-click-out","p-hide-close"]],template:function(o,s){if(1&o){const a=e.RV6();e.j41(0,"div",3)(1,"po-button",4),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.buttonsAction("Encerrar"))}),e.k0s(),e.j41(2,"po-button",5),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.buttonsAction("Rastrear"))}),e.k0s()(),e.j41(3,"po-popup",6,0)(5,"div",7)(6,"div",8),e.EFF(7," Informa\xe7\xf5es "),e.j41(8,"div"),e.EFF(9,"teste de po-popup"),e.k0s()()()(),e.j41(10,"po-modal",9,1)(12,"div"),e.nrm(13,"po-loading-overlay",10),e.k0s(),e.j41(14,"po-table",11),e.bIt("p-selected",function(C){return e.eBV(a),e.Njj(s.onClickSelectLineTracer(C))})("p-unselected",function(){return e.eBV(a),e.Njj(s.onClickUnselectLineTracer())}),e.k0s(),e.j41(15,"po-modal-footer")(16,"po-button",12),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.cleanTracer())}),e.k0s(),e.j41(17,"po-button",13),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.changeLabelStartStop())}),e.k0s(),e.j41(18,"po-button",14),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.copyTracerLine())}),e.k0s(),e.j41(19,"po-button",15),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.saveTracerToFile())}),e.k0s(),e.j41(20,"po-button",16),e.bIt("p-click",function(){return e.eBV(a),e.Njj(s.setStopInformations())}),e.k0s()()(),e.j41(21,"po-modal",17,2),e.EFF(23),e.k0s()}if(2&o){const a=e.sdS(11);e.R7$(),e.Y8G("p-disabled",!s.isUserKiller),e.R7$(2),e.Y8G("p-actions",e.eq3(23,E,e.lJ4(22,u)))("p-target",a),e.R7$(7),e.Y8G("p-hide-close",!0)("p-click-out",!1),e.R7$(3),e.Y8G("hidden",s.isHideLoading),e.R7$(),e.Y8G("p-columns",s.tracerColumns)("p-items",s.tracerItems)("p-height",400)("p-hide-columns-manager",!0)("p-infinite-scroll",!0)("p-selectable",!0)("p-selectable-entire-line",!0)("p-single-select",!0)("p-striped",!0)("p-max-columns",4),e.R7$(3),e.Y8G("p-label",s.startStopButtonTracer),e.R7$(),e.Y8G("p-disabled",s.tracerItems.length<1),e.R7$(),e.Y8G("p-disabled",s.tracerItems.length<1),e.R7$(2),e.Y8G("p-click-out",!1)("p-hide-close",!0),e.R7$(2),e.SpI(" [Info] Operations Calls: OP_CONNSETUP....:1 (0.004 s) TOTAL I/O COUNT....:1 [INFO]Trace Total Timer (3)s ",s.closeInformations,"\n")}},dependencies:[g.MD,S.w,c.rmE,c.LgA,c.I3z,c.Fu6,c.ff3,c.NZw],styles:[".sample-popup-header-template[_ngcontent-%COMP%]{border-top-left-radius:3px;border-top-right-radius:3px;color:#0c9abe;padding-bottom:5%;padding-left:25%;padding-top:5%}"]})}return p})();var U=l(9056),f=l(6697),L=l(287);const D=["UsersTable"];let F=null,w=(()=>{class p{constructor(t,o,s){this.userService=t,this.connectionService=o,this.messagesService=s,this.idSelected="",this.isHideLoading=!1,this.overlayText="Carregando usu\xe1rios",this.headerFields=[],this.userItems=[],this.tableSpaceColumn=c.FZk.Small,this.unsubscribe$=new n.B,this.refreshTax=2,this.isUserAdmin=!1,this.isUserKiller=!1,this.userColumns=[{property:"id",label:"Id",visible:!0},{property:"user",label:"Usu\xe1rio",sortable:!0},{property:"io_total",label:"Total IOs",sortable:!0},{property:"io_time",label:"IOs/Seg"},{property:"tables",label:"Tabelas"},{property:"procedure",label:"Procedure"},{property:"comments",label:"Coment\xe1rios"},{property:"environment",label:"Ambiente"},{property:"db_thread",label:"DB Thread"},{property:"start",label:"Start"},{property:"ip_origin",label:"IP Origin"},{property:"idle",label:"IDLE(s)"},{property:"in_transaction",label:"Em Transa\xe7\xe3o"},{property:"memory",label:"Memoria(KB)"},{property:"running",label:"Executando"},{property:"number_locks",label:"Qtd.Locks"},{property:"licensed",label:"Licenciado"},{property:"slave",label:"Slave"},{property:"thread_id",label:"Thread ID"}],this.Timer=new L.A(5,1e3*this.refreshTax,()=>this.separaUsers(),()=>this.erroTempoDesconexao())}ngOnInit(){this.headerFields||this.userService.getUsersFieldsInStorage(),this.getUserItems(),this.connectionService.getConnectionUserData().pipe((0,f.s)(1)).subscribe({next:t=>{this.isUserAdmin=t?.admin,this.isUserKiller=t?.canKill,this.connectData=t},error:t=>{console.error(t),this.messagesService.handleError(t)}}),this.userService.getRefreshRate().pipe((0,f.s)(1)).subscribe({next:t=>{this.refreshTax=t},error:t=>this.messagesService.handleError(t)})}getUserItems(){this.getUserData().subscribe({next:t=>{this.isHideLoading=!0,F||this.startAutoTracer(),this.userItems=t},error:t=>{console.error(t),this.messagesService.handleError(t),this.stopAutoTracer()}})}userIsClosed(t){t&&(this.overlayText="Encerrando Conex\xe3o",this.isHideLoading=!1,this.contadorId=this.Timer.start())}getUserData(){return this.userService.getUsers().pipe((0,r.Q)(this.unsubscribe$))}eventLineSelected(t){this.stopAutoTracer(),this.lineSelected=t,this.idSelected=this.lineSelected.id}eventLineUnselected(){this.startAutoTracer(),this.lineSelected=null}startAutoTracer(){F=setInterval(()=>{this.getUserItems()},1e3*this.refreshTax)}stopAutoTracer(){clearInterval(F)}ngOnDestroy(){this.stopAutoTracer(),this.unsubscribe$.next(!1),this.unsubscribe$.complete()}separaUsers(){this.getUserData().subscribe({next:t=>{t&&this.idSelected.length>0&&this.lerdados(t).then(o=>{o||this.informarEncerramento()})},error:t=>{console.error(t),this.messagesService.handleError(t),this.Timer.reset(this.contadorId)}})}lerdados(t){var o=this;return(0,v.A)(function*(){let s=!1;for(const a in t)t[a].id===o.idSelected&&(s=!0);return s})()}informarEncerramento(){this.eventLineUnselected(),this.Timer.reset(this.contadorId),this.messagesService.handleMessage("Conex\xe3o do usu\xe1rio encerrada com sucesso !","success"),this.isHideLoading=!0}erroTempoDesconexao(){this.messagesService.handleMessage("Tempo de verifica\xe7\xe3o de desconex\xe3o esgotado... verifique","error"),this.Timer.reset(this.contadorId)}static#e=this.\u0275fac=function(o){return new(o||p)(e.rXU(b.g),e.rXU(U.K),e.rXU(_))};static#t=this.\u0275cmp=e.VBU({type:p,selectors:[["tlppcore-ux-users"]],viewQuery:function(o,s){if(1&o&&e.GBs(D,7),2&o){let a;e.mGM(a=e.lsd())&&(s.usersTable=a.first)}},standalone:!0,features:[e.aNF],decls:5,vars:14,consts:[["usersTable",""],[3,"hidden","p-screen-lock","p-text"],[1,"po-row"],["p-container","border","p-hide-batch-actions","true",1,"po-md-12",3,"p-selected","p-unselected","p-columns","p-items","p-height","p-hide-columns-manager","p-infinite-scroll","p-selectable","p-selectable-entire-line","p-single-select","p-striped","p-spacing"],[3,"userClosed","lineSelected"]],template:function(o,s){if(1&o){const a=e.RV6();e.nrm(0,"po-loading-overlay",1),e.j41(1,"div",2)(2,"po-table",3,0),e.bIt("p-selected",function(C){return e.eBV(a),e.Njj(s.eventLineSelected(C))})("p-unselected",function(){return e.eBV(a),e.Njj(s.eventLineUnselected())}),e.k0s()(),e.j41(4,"user-footer",4),e.bIt("userClosed",function(C){return e.eBV(a),e.Njj(s.userIsClosed(C))}),e.k0s()}2&o&&(e.Y8G("hidden",s.isHideLoading)("p-screen-lock",!0)("p-text",s.overlayText),e.R7$(2),e.Y8G("p-columns",s.userColumns)("p-items",s.userItems)("p-height",600)("p-hide-columns-manager",!0)("p-infinite-scroll",!0)("p-selectable",!0)("p-selectable-entire-line",!0)("p-single-select",!0)("p-striped",!0)("p-spacing",s.tableSpaceColumn),e.R7$(2),e.Y8G("lineSelected",s.lineSelected))},dependencies:[g.MD,S.w,c.LgA,c.NZw,A]})}return p})()},2578:function(j,k){var l,g;void 0!==(g="function"==typeof(l=function(){"use strict";function c(n,r,d){var i=new XMLHttpRequest;i.open("GET",n),i.responseType="blob",i.onload=function(){T(i.response,r,d)},i.onerror=function(){console.error("could not download file")},i.send()}function S(n){var r=new XMLHttpRequest;r.open("HEAD",n,!1);try{r.send()}catch{}return 200<=r.status&&299>=r.status}function b(n){try{n.dispatchEvent(new MouseEvent("click"))}catch{var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),n.dispatchEvent(r)}}var m="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,_=m.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),T=m.saveAs||("object"!=typeof window||window!==m?function(){}:"download"in HTMLAnchorElement.prototype&&!_?function(n,r,d){var i=m.URL||m.webkitURL,u=document.createElement("a");u.download=r=r||n.name||"download",u.rel="noopener","string"==typeof n?(u.href=n,u.origin===location.origin?b(u):S(u.href)?c(n,r,d):b(u,u.target="_blank")):(u.href=i.createObjectURL(n),setTimeout(function(){i.revokeObjectURL(u.href)},4e4),setTimeout(function(){b(u)},0))}:"msSaveOrOpenBlob"in navigator?function(n,r,d){if(r=r||n.name||"download","string"!=typeof n)navigator.msSaveOrOpenBlob(function e(n,r){return typeof r>"u"?r={autoBom:!1}:"object"!=typeof r&&(console.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(n.type)?new Blob(["\ufeff",n],{type:n.type}):n}(n,d),r);else if(S(n))c(n,r,d);else{var i=document.createElement("a");i.href=n,i.target="_blank",setTimeout(function(){b(i)})}}:function(n,r,d,i){if((i=i||open("","_blank"))&&(i.document.title=i.document.body.innerText="downloading..."),"string"==typeof n)return c(n,r,d);var u="application/octet-stream"===n.type,E=/constructor/i.test(m.HTMLElement)||m.safari,y=/CriOS\/[\d]+/.test(navigator.userAgent);if((y||u&&E||_)&&typeof FileReader<"u"){var I=new FileReader;I.onloadend=function(){var f=I.result;f=y?f:f.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=f:location=f,i=null},I.readAsDataURL(n)}else{var A=m.URL||m.webkitURL,U=A.createObjectURL(n);i?i.location=U:location.href=U,i=null,setTimeout(function(){A.revokeObjectURL(U)},4e4)}});m.saveAs=T.saveAs=T,j.exports=T})?l.apply(k,[]):l)&&(j.exports=g)}}]);